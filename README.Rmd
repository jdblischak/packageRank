---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">",
  fig.path = "man/figures/README-"
)
```

```{r, echo = FALSE}
library(packageRank)
```

## packageRank: compute and visualize package download counts and percentiles

### features

* provide S3 plot methods for 'cranlogs' output.
* compute the rank percentile and nominal rank of a package's downloads from RStudio's [CRAN mirror](http://cran-logs.rstudio.com).
* visualize a package's position in the  distribution of package download counts for a given day (cross-sectionally) or over time (longitudinally).

NOTE: 'packageRank' relies on an active internet connection.

### background

The '[cranlogs](https://cran.r-project.org/package=cranlogs)' package computes the number of downloads using RStudio's [CRAN mirror](http://cran-logs.rstudio.com). For example, we can see that the '[HistData](https://cran.r-project.org/package=HistData)' package was downloaded 51 times on the first day of 2019:

```{r cranlogs1}
cranlogs::cran_downloads(packages = "HistData", from = "2019-01-01",
  to = "2019-01-01")
```

And 787 times in the first week:

```{r cranlogs2}
cranlogs::cran_downloads(packages = "HistData", from = "2019-01-01",
  to = "2019-01-07")
```

In both cases, the "compared to what?" question lurks in the background. Is 51 downloads large or small? Is the pattern during that week typical or unusual? To help answer these questions, 'packageRank' tries to provide some perspective on package download counts.

### visualizing 'cranlogs'

To visualize output from `cranlogs::cran_download()`, 'packageRank' provides easy-to-use S3 generic plot() methods. All you need to do is to use cran_downloads2() in place of cran_download():

```{r cranlogsB1, fig.width = 5, fig.height = 5, fig.align = "left"}
plot(cran_downloads2(package = c("data.table", "Rcpp", "rlang"),
  from = "2019-01-01", to = "2019-01-01"), graphics_pkg = "base")
```

```{r cranlogsB2, fig.width = 5, fig.height = 5, fig.align = "left"}
plot(cran_downloads2(package = c("data.table", "Rcpp", "rlang"),
  when = "last-month"))
```

```{r cranlogsB3, fig.width = 6, fig.height = 6, fig.align = "left"}
plot(cran_downloads2(package = c("data.table", "Rcpp", "rlang"),
  from = "2019-01-01", to = "2019-01-31"))
```

### compute percentiles and ranks

To compute a package's rank percentile and nominal rank, in addition to raw download counts, use `packageRank()`:

```{r packageRank1}
packageRank(package = "HistData", date = "2019-01-01")
```

Doing so, we see that 51 downloads places 'HistData' in the 93rd percentile. This statistic, familiar to anyone who's taken a standardized test, tell us that 93% of packages had fewer downloads than 'HistData':^[Note that because packages with zero downloads are not recorded in the log, there is a censoring problem.]

```{r percentile}
pkg.rank <- packageRank(package = "HistData", date = "2019-01-01")
downloads <- pkg.rank$crosstab

round(100 * mean(downloads < downloads["HistData"]), 1)

# OR

(pkgs.with.fewer.downloads <- sum(downloads < downloads["HistData"]) )

(tot.pkgs <- length(downloads))

round(100 * pkgs.with.fewer.downloads / tot.pkgs , 1)
```

We also see that 51 downloads "nominally" earns 'HistData' 920th place of the 14,020 packages downloaded. The rank is "nominal" because it's possible that multiple packages will have identical numbers of downloads. As a result, a package's nominal rank (but not its rank percentile) will sometimes be affected by the fact that ties are sorted by the alphabetical order of packagess names. Here, 'HistData' benefits from the fact that it appears second in the list (vector) of packages with 51 downloads:

```{r nominal}
pkg.rank <- packageRank(package = "HistData", date = "2019-01-01")
downloads <- pkg.rank$crosstab

downloads[downloads == 51]
```

To avoid the bottleneck of downloading multiple log file, `packageRank()` is currently limited to individual days. However, to reduce the need to re-download logs for each function call, 'packageRank' will make use of memoization via the 'memoise' package.

### memoization

Here's relevant code:

```{r memoization, eval = FALSE}
fetchLog <- function(x) data.table::fread(x)

mfetchLog <- memoise::memoise(fetchLog)

if (RCurl::url.exists(url)) {
  cran_log <- mfetchLog(url)
}
```

If you use `fetchLog()`, the log file, which can be as large as 50 MB, will be downloaded with each function call. If you use `mfetchLog()`, logs are intelligently cached: logs that have already been downloaded in the current session will not be downloaded again.

### visualization (cross-sectional)

To visualize a package's position in the distribution on a given day's downloads, use the following:

```{r plot1, fig.width = 5, fig.height = 5, fig.align = "left"}
plot(packageRank(package = "HistData", date = "2019-05-01"),
  graphics_pkg = "base")
```

This cross-sectional view plots a package's rank (x-axis) against the logarithm of its downloads (y-axis) and highlights the package's relative position in the overall distribution. In addition, it illustrates its percentile and its number of downloads (in red); the location of the 75th, 50th and 25th percentiles (dotted gray vertical lines); the package with the most downloads (in this case 'devtools') and the total number of downloads (2,982,767) from the CRAN mirror on that day (both in blue).

Just like cranlogs::cran_downloads(), you can also pass a vector of packages:

```{r plot2, fig.width = 6, fig.height = 6, fig.align = "left"}
plot(packageRank(package = c("cholera", "HistData", "regtools"),
  date = "2019-05-01"))
```

### visualization (longitudinal)

To visualize a package's position in the distribution on a given day's downloads, use `packageRankTime()`. Currently, only two time frames, "last-week" and "last-month" are available.

```{r plot_ts, fig.width = 5, fig.height = 5, fig.align = "left"}
plot(packageRankTime(package = "HistData", when = "last-month"),
  graphics_pkg = "base")
```

The longitudinal view plots the date (x-axis) against the logarithm of a package's downloads (y-axis). In the background, we can see the same data, plotted in gray, for a stratified random sample of packages.^[Within each 5% interval of rank percentiles (e.g., 0 to 5, 5 to 10, 95 to 100, etc.), a random sample of 5% of packages is selected and tracked over time.] This sample is used to approximate the temporal pattern of all package downloads.

As above, you can pass a vector of packages:

```{r plot_ts2, fig.width = 6, fig.height = 6, fig.align = "left"}
plot(packageRankTime(package = c("Rcpp", "HistData", "rlang"),
  when = "last-month"))
```

### graphics: base R and 'ggplot2'

All plot are available as both base R graphics and 'ggplot2' figures via the graphics_pkg argument ("base" or "ggplot2") in the plot() methods.

### installation

To install the development version of 'packageRank' from GitHub:

```{r, eval = FALSE}
# For 'devtools' (< 2.0.0)
devtools::install_github("lindbrook/packageRank", build_vignettes = TRUE)

# For 'devtools' (>= 2.0.0)
devtools::install_github("lindbrook/packageRank", build_opts = c("--no-resave-data", "--no-manual"))
```

### Notes
